# -*- coding: utf-8 -*-
"""Ecocnom√≠a Circular.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1TLsH40EaVazpxNndR8h2ugCyffLoDXsZ
"""

# app.py
# ---------------------------------------------------------
# MiPyME Conecta - Asignaci√≥n Eficiente de Cr√©dito
# Econom√≠a Circular + Polos de Desarrollo + Random Forest
# Versi√≥n optimizada para pitch (ULTRA R√ÅPIDA)
# Con Login de Usuario
# ---------------------------------------------------------

import streamlit as st
import pandas as pd
import numpy as np
from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import train_test_split
from sklearn.metrics import accuracy_score
import plotly.express as px

# ---------------------------------------------------------
# CONFIGURACI√ìN GENERAL
# ---------------------------------------------------------
st.set_page_config(layout="wide", page_title="Asignaci√≥n Inteligente de Cr√©dito MiPyME")

# ---------------------------------------------------------
# LOGIN SIMPLE (USUARIO Y CLAVE)
# ---------------------------------------------------------
USUARIOS = {
    "admin": "1234",
    "pitch": "demo2025",
    "invitado": "credito"
}

def login():
    st.title("üîê Acceso a MiPyME Conecta")
    usuario = st.text_input("Usuario")
    clave = st.text_input("Contrase√±a", type="password")

    if st.button("Ingresar"):
        if usuario in USUARIOS and USUARIOS[usuario] == clave:
            st.session_state["autenticado"] = True
            st.session_state["usuario"] = usuario
            st.success("‚úÖ Acceso correcto")
            st.rerun()
        else:
            st.error("‚ùå Usuario o contrase√±a incorrectos")

if "autenticado" not in st.session_state:
    st.session_state["autenticado"] = False

if not st.session_state["autenticado"]:
    login()
    st.stop()

# ---------------------------------------------------------
# ENCABEZADO PRINCIPAL
# ---------------------------------------------------------
st.title("üí≥ Asignaci√≥n Inteligente de Cr√©dito para MiPyMEs")
st.caption(f"Usuario activo: {st.session_state['usuario']}")

st.markdown("""
Plataforma de **IA ligera** para priorizar MiPyMEs con:
- üå± Econom√≠a Circular
- üìç Polos de Desarrollo
- üë© Liderazgo Femenino
- üè¶ Alta probabilidad de acceso a cr√©dito
""")

# ---------------------------------------------------------
# GENERADOR DE DATOS R√ÅPIDO (para el pitch)
# ---------------------------------------------------------
@st.cache_data
def generate_sample(n=2000, seed=42):
    np.random.seed(seed)
    estados = ['CDMX','Jalisco','Nuevo Le√≥n','Puebla','Oaxaca','Veracruz']
    sectores = ['Manufactura','Comercio','Servicios','Agro']

    df = pd.DataFrame({
        'estado': np.random.choice(estados, n),
        'sector': np.random.choice(sectores, n),
        'ventas': np.random.lognormal(mean=10, sigma=1, size=n),
        'empleados': np.random.poisson(6, n),
        'lider_mujer': np.random.binomial(1, 0.35, n),
        'recicla_pct': np.random.beta(2,5,n),
        'digital_score': np.random.beta(2,2,n),
        'factura_e': np.random.binomial(1, 0.5, n),
        'ventas_online_pct': np.random.beta(1.5,4,n),
    })

    score = (
        0.25 * df['digital_score'] +
        0.25 * df['factura_e'] +
        0.2  * df['recicla_pct'] +
        0.15 * df['lider_mujer'] +
        0.15 * np.log1p(df['ventas'])
    )

    df['credito'] = (score > score.quantile(0.7)).astype(int)
    return df

df = generate_sample()

# ---------------------------------------------------------
# ENTRENAMIENTO ULTRA R√ÅPIDO CON RANDOM FOREST
# ---------------------------------------------------------
@st.cache_resource
def train_model(df):
    features = [
        'ventas','empleados','recicla_pct','digital_score',
        'factura_e','ventas_online_pct','lider_mujer'
    ]

    X = df[features]
    y = df['credito']

    X_train, X_test, y_train, y_test = train_test_split(
        X, y, test_size=0.25, random_state=42
    )

    model = RandomForestClassifier(
        n_estimators=120,
        max_depth=8,
        random_state=42,
        n_jobs=-1
    )

    model.fit(X_train, y_train)

    acc = accuracy_score(y_test, model.predict(X_test))
    return model, acc, features

model, acc, FEATURES = train_model(df)

# ---------------------------------------------------------
# M√âTRICAS GENERALES
# ---------------------------------------------------------
st.subheader("üìä Estado Actual del Cr√©dito")
col1, col2 = st.columns(2)

with col1:
    st.metric("Precisi√≥n del modelo IA", f"{acc:.2%}")

with col2:
    st.metric("MiPyMEs con cr√©dito", f"{df['credito'].mean()*100:.2f}%")

# ---------------------------------------------------------
# √çNDICE DE ECONOM√çA CIRCULAR
# ---------------------------------------------------------
df['indice_circular'] = (
    0.4*df['recicla_pct'] +
    0.4*df['ventas_online_pct'] +
    0.2*df['digital_score']
)

fig1 = px.histogram(df, x='indice_circular', nbins=25,
                     title="Distribuci√≥n del √çndice de Econom√≠a Circular")

st.plotly_chart(fig1, use_container_width=True)

# ---------------------------------------------------------
# POLOS DE DESARROLLO
# ---------------------------------------------------------
state_agg = df.groupby('estado').agg({
    'credito':'mean',
    'indice_circular':'mean',
    'ventas':'count'
}).reset_index().rename(columns={'ventas':'empresas'})

fig2 = px.scatter(
    state_agg,
    x='empresas',
    y='indice_circular',
    size='empresas',
    color='credito',
    hover_name='estado',
    title="Polos de Desarrollo: Empresas vs Econom√≠a Circular"
)

st.plotly_chart(fig2, use_container_width=True)

# ---------------------------------------------------------
# EVALUADOR DE CR√âDITO
# ---------------------------------------------------------
st.subheader("‚úÖ Evaluaci√≥n Inteligente de Cr√©dito (IA en Tiempo Real)")

with st.form("evaluacion"):
    ventas = st.number_input("Ventas anuales (MXN)", value=1_000_000)
    empleados = st.number_input("Empleados", value=6)
    recicla = st.slider("Econom√≠a circular", 0.0, 1.0, 0.2)
    digital = st.slider("Digitalizaci√≥n", 0.0, 1.0, 0.3)
    factura = st.selectbox("Factura electr√≥nica", [0,1])
    online = st.slider("Ventas online", 0.0, 1.0, 0.1)
    mujer = st.selectbox("Liderazgo femenino", [0,1])

    evaluar = st.form_submit_button("Evaluar con IA")

    if evaluar:
        x = pd.DataFrame([[
            ventas, empleados, recicla, digital,
            factura, online, mujer
        ]], columns=FEATURES)

        prob = model.predict_proba(x)[0,1]
        st.success(f"üîÆ Probabilidad estimada de cr√©dito: {prob:.2%}")

# ---------------------------------------------------------
# SIMULADOR DE POL√çTICA P√öBLICA
# ---------------------------------------------------------
st.subheader("üìà Simulador de Impacto en Acceso a Cr√©dito")

capacitacion = st.slider("Cobertura de capacitaci√≥n digital (%)", 0, 50, 10)
impacto = 0.002 * capacitacion

actual = df['credito'].mean()
proyectado = actual + impacto

st.write(f"Acceso actual: {actual:.2%}")
st.write(f"Acceso proyectado: {proyectado:.2%}")

if proyectado - actual >= 0.035:
    st.success("‚úÖ Se cumple la meta anual del +3.5%")
else:
    st.warning("‚ö†Ô∏è No se alcanza la meta del +3.5%")

# ---------------------------------------------------------
# IMPORTANCIA DE VARIABLES
# ---------------------------------------------------------
st.subheader("üß† Variables m√°s importantes para otorgar cr√©dito")

imp = pd.DataFrame({
    'Variable': FEATURES,
    'Importancia': model.feature_importances_
}).sort_values(by='Importancia', ascending=False)

st.dataframe(imp)

# ---------------------------------------------------------
# LOGOUT
# ---------------------------------------------------------
if st.button("üö™ Cerrar sesi√≥n"):
    st.session_state["autenticado"] = False
    st.rerun()

st.caption("Modelo Random Forest optimizado para servidores gratuitos | Hackat√≥n 2025")

# Personalizaci√≥n de dise√±o
st.markdown("""
<style>
    .stApp {
        background-color:  #5BF58E;
    }
    .css-1d391kg {
        color:  #000000;
    }
</style>
""", unsafe_allow_html=True)
