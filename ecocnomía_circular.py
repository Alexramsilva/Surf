# -*- coding: utf-8 -*-
"""Ecocnom√≠a Circular.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1TLsH40EaVazpxNndR8h2ugCyffLoDXsZ
"""

import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px

st.set_page_config(page_title="Cr√©dito Inteligente MiPyME", layout="wide")

st.title("üí≥ Asignaci√≥n Inteligente de Cr√©dito para MiPyMEs")
st.success("Demo en tiempo real ‚Äî IA para econom√≠a circular, polos de desarrollo y g√©nero")

st.markdown("""
Este prototipo prioriza MiPyMEs con:
- üå± Econom√≠a circular
- üìç Polos de desarrollo
- üë© Liderazgo femenino
- üíª Digitalizaci√≥n
""")

# -----------------------------
# DATOS SINT√âTICOS MUY R√ÅPIDOS
# -----------------------------
@st.cache_data
def generar_datos(n=600):
    np.random.seed(42)
    estados = ['CDMX','Jalisco','NL','Puebla','Oaxaca','Veracruz']

    df = pd.DataFrame({
        "estado": np.random.choice(estados, n),
        "ventas": np.random.randint(200_000, 5_000_000, n),
        "empleados": np.random.randint(1, 50, n),
        "recicla": np.random.rand(n),
        "digital": np.random.rand(n),
        "mujer": np.random.binomial(1, 0.35, n)
    })

    # MODELO INTELIGENTE SIMULADO (ultra r√°pido)
    score = (
        0.35 * df["digital"] +
        0.30 * df["recicla"] +
        0.20 * df["mujer"] +
        0.15 * np.log1p(df["ventas"])
    )

    df["credito"] = (score > score.quantile(0.7)).astype(int)
    df["score"] = score
    return df

df = generar_datos()

# -----------------------------
# KPI PRINCIPALES
# -----------------------------
col1, col2, col3 = st.columns(3)

col1.metric("MiPyMEs con cr√©dito", f"{df['credito'].mean()*100:.1f}%")
col2.metric("Empresas evaluadas", f"{len(df)}")
col3.metric("Score promedio IA", f"{df['score'].mean():.3f}")

# -----------------------------
# POLOS DE DESARROLLO (R√ÅPIDO)
# -----------------------------
st.subheader("üìç Polos de Desarrollo")

polos = df.groupby("estado").agg(
    empresas=("ventas","count"),
    credito=("credito","mean"),
    score=("score","mean")
).reset_index()

fig = px.scatter(
    polos,
    x="empresas",
    y="score",
    size="empresas",
    color="credito",
    hover_name="estado",
    title="Estados Prioritarios para Cr√©dito"
)

st.plotly_chart(fig, use_container_width=True)

# -----------------------------
# EVALUADOR DE CR√âDITO EN VIVO
# -----------------------------
st.subheader("‚úÖ Evaluaci√≥n Inteligente de una MiPyME")

with st.form("eval"):
    ventas = st.number_input("Ventas anuales (MXN)", 100000, 10_000_000, 1_000_000)
    empleados = st.number_input("Empleados", 1, 100, 8)
    recicla = st.slider("Nivel de econom√≠a circular", 0.0, 1.0, 0.3)
    digital = st.slider("Nivel de digitalizaci√≥n", 0.0, 1.0, 0.4)
    mujer = st.selectbox("¬øLiderazgo femenino?", [0,1])

    evaluar = st.form_submit_button("Evaluar cr√©dito")

    if evaluar:
        score = (
            0.35 * digital +
            0.30 * recicla +
            0.20 * mujer +
            0.15 * np.log1p(ventas)
        )

        prob = min(score, 1)

        if prob > 0.6:
            st.success(f"‚úÖ Cr√©dito aprobado con probabilidad estimada de {prob:.1%}")
        else:
            st.warning(f"‚ö†Ô∏è Riesgo crediticio ‚Äî Probabilidad estimada: {prob:.1%}")

# -----------------------------
# SIMULADOR DE POL√çTICA P√öBLICA
# -----------------------------
st.subheader("üìà Simulador de Impacto en Cr√©dito")

cap = st.slider("Cobertura de capacitaci√≥n digital (%)", 0, 50, 10)
impacto = cap * 0.002

actual = df["credito"].mean()
nuevo = actual + impacto

st.write(f"Acceso actual: {actual:.2%}")
st.write(f"Acceso proyectado: {nuevo:.2%}")

if nuevo - actual >= 0.035:
    st.success("‚úÖ Se cumple la meta anual de +3.5%")
else:
    st.warning("‚ö†Ô∏è No se alcanza a√∫n la meta del +3.5%")

st.caption("Prototipo optimizado para pitch: IA ligera, decisiones en tiempo real, sin tiempos muertos.")